
# Crear router-nat con Vagrant

## Objetivo:

**Tarea 4**: Configura el servidor para que funcione como **router** y **NAT**, de esta forma los clientes tengan internet. Muestra las rutas por defecto del servidor y el cliente. Realiza una prueba de funcionamiento para comprobar que el cliente tiene acceso a internet (utiliza nombres, para comprobar que tiene resolución DNS).

## 1. ESCENARIO

El escenario tiene dos máquinas virtuales:

* **servidor**, que está conectada a una red pública y a una red privada. La interfaz de red en la red privada (**eth2**) se configura con la IP **192.168.200.2**. La máquina servidor debe acceder a internet por **eth1** (puente con la anfitriona). La interfaz **eth0** sólo se utiliza para acceder a la máquina con vagrant ssh.

* **nodolan1**: Esta máquina está conectada a la misma red privada que la máquina anterior, en este caso su direccionamiento es **192.168.200.50** (Este direccionamiento lo toma desde el servidor dhcp). La máquina cliente debe tener acceso a internet, para ello debe salir por **eth1** y la máquina router debe estar configurada para enrutar las peticiones de cliente. del mismo modo, eth0 sólo se utiliza para acceder con vagrant ssh.

![escenario.jpeg](https://github.com/CeliaGMqrz/servidor_DHCPv4/blob/main/capturas/escenario.jpeg)

## 2. CONFIGURAR SERVIDOR DHCP COMO ROUTER

**PASO 1: Cambiar ruta por defecto**

* Primero vamos a ver por donde tenemos acceso a la red. En este caso vemos con **ip r** que tenemos acceso desde 'eth0' y nos interesa que tengamos red desde 'eth1':

```sh
root@servidor:/home/vagrant# ip r
default via 10.0.2.2 dev eth0 
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 
192.168.100.0/24 dev eth1 proto kernel scope link src 192.168.100.156 
192.168.200.0/24 dev eth2 proto kernel scope link src 192.168.200.2 

```

* Tenemos que cambiar la ruta por defecto para tener acceso por eth1 a la red en vez de eth0.

```sh
ip route change default via 192.168.100.1 dev eth1
```
* Comprobamos que ya se ha modificado la ruta por defecto y tenemos conexión al exterior por eth1.

```sh 
root@servidor:/home/vagrant# ip r
default via 192.168.100.1 dev eth1 
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 
192.168.100.0/24 dev eth1 proto kernel scope link src 192.168.100.156 
192.168.200.0/24 dev eth2 proto kernel scope link src 192.168.200.2 

```
![ping01.png](https://github.com/CeliaGMqrz/servidor_DHCPv4/blob/main/capturas/ping01.png)

**PASO 2: Activar el bit de fordward**

* Para que nuestra máquina actúe como router tenemos que activar el **bit de fordward**. Podemos hacerlo temporal o permanente. En este caso lo haremos permanente. Para ello editamos el fichero /etc/sysctl.conf , buscamos la línea ‘net.ipv4.ip_fordward=’1 y la descomentamos.

```sh
nano /etc/sysctl.conf 
```

```sh
# Uncomment the next line to enable packet forwarding for IPv4
net.ipv4.ip_forward=1

```
**PASO 3: Modificar Fichero interfaces** 
* En segundo lugar vamos a configurar el fichero **/etc/network/interfaces** agregando dos reglas de *‘iptable’* para que nuestros clientes puedan acceder desde una interfaz a otra obteniendo acceso a internet. Añadiremos las siguientes líneas:

#### FICHERO INTERFACES

```sh
nano /etc/network/interfaces
```

#### REGLAS DE IP TABLE

```sh
#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
auto eth1
iface eth1 inet dhcp
    post-up ip route del default dev $IFACE || true

up iptables -t nat -A POSTROUTING -o eth1 -s 192.168.200.50/24 -j MASQUERADE
down iptables -t nat -D POSTROUTING -o eth1 -s 192.168.200.50/24 -j MASQUERADE

```

Las añadimos de forma permanente en el fichero interfaces, de forma que:

* -A POSTROUTING (Añade una regla a la cadena POSTROUTING)
* -s ‘dirección’ : Se aplica a los paquetes que vengan de origen de la dirección especificada. En nuestro caso hemos añadido las direccion ip de nuestro cliente
* -o eth1: Se aplica a los paquetes que salgan por eth1
* -j MASQUERADE: Cambia la dirección de origen por la dirección de salida
(eth1)


* Reiniciamos el servicio.

 ```sh
 root@servidor:/home/vagrant# /etc/init.d/networking restart
[ ok ] Restarting networking (via systemctl): networking.service.

 ```

* Vemos el direccionamiento de nuestras interfaces.

```sh
root@servidor:/home/vagrant# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:8d:c0:4d brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic eth0
       valid_lft 86395sec preferred_lft 86395sec
    inet6 fe80::a00:27ff:fe8d:c04d/64 scope link 
       valid_lft forever preferred_lft forever
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:7a:ea:95 brd ff:ff:ff:ff:ff:ff
    inet 192.168.100.156/24 brd 192.168.100.255 scope global dynamic eth1
       valid_lft 3593sec preferred_lft 3593sec
    inet6 fe80::a00:27ff:fe7a:ea95/64 scope link 
       valid_lft forever preferred_lft forever
4: eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:45:37:81 brd ff:ff:ff:ff:ff:ff
    inet 192.168.200.2/24 brd 192.168.2.255 scope global eth2
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fe45:3781/64 scope link 
       valid_lft forever preferred_lft forever


```

* **eth0** (10.0.2.15) es por donde nos conectamos con vagrant y virtualbox.
* **eth1** (192.168.100.156) es nuestra dirección pública, el enlace entre el router y  nuestra máquina anfitriona.
* **eth2** (192.168.200.2), la interfaz de la red privada que se comunica con nuestro cliente en forma de puerta de enlace.

## 3. CONFIGURAR CLIENTE

* Vemos la ruta por defecto de nuestro cliente, que actualmente es por eth0.

```sh
root@nodolan1:/home/vagrant# ip r
default via 10.0.2.2 dev eth0 
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 
192.168.200.0/24 dev eth1 proto kernel scope link src 192.168.200.50 

```

* Cambiamos la **ruta por defecto** o lo que es lo mismo la **puerta de enlace** para que salga por **eth1**. Indicando la puerta de enlace que es la dirección de nuestro servidor (interfaz eth2 red privada)

```sh
ip route change default via 192.168.200.2 dev eth1
```
* Ahora vemos cual es la ruta por defecto que toma nuestro cliente

```sh
root@nodolan1:/home/vagrant# ip r
default via 192.168.200.2 dev eth1 
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 
192.168.200.0/24 dev eth1 proto kernel scope link src 192.168.200.50 

```

* Fichero interfaces

```sh
# The primary network interface
allow-hotplug eth0
iface eth0 inet dhcp
#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
auto eth1
iface eth1 inet dchp
#VAGRANT-END

```
* Direccionamiento actual

```sh
root@nodolan1:/home/vagrant# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:8d:c0:4d brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic eth0
       valid_lft 85869sec preferred_lft 85869sec
    inet6 fe80::a00:27ff:fe8d:c04d/64 scope link 
       valid_lft forever preferred_lft forever
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:cf:b2:45 brd ff:ff:ff:ff:ff:ff
    inet 192.168.200.50/24 brd 192.168.200.255 scope global dynamic eth1
       valid_lft 37604sec preferred_lft 37604sec
    inet6 fe80::a00:27ff:fecf:b245/64 scope link 
       valid_lft forever preferred_lft forever

```
**PASO 4: COMPROBAR CONEXIONES** 

* Ahora ya podemos ver si tenemos acceso a la red desde el cliente por la interfaz eth1, y efectivamente está en buen funcionamiento nuestro router nat y el cliente configurado adecuadamente.

![ping0.png](https://github.com/CeliaGMqrz/servidor_DHCPv4/blob/main/capturas/ping0.png)


### **Resolucion de nombres** 

* Editar fichero /etc/resolv.conf. Le añadimos el **nameserver 8.8.8.8**

```sh
domain s01.local
search s01.local
nameserver 192.168.200.2
nameserver 8.8.8.8
```

* Comprobaciones: 

![ping1.png](https://github.com/CeliaGMqrz/servidor_DHCPv4/blob/main/capturas/ping1.png)
![ping2.png](https://github.com/CeliaGMqrz/servidor_DHCPv4/blob/main/capturas/ping2.png)
