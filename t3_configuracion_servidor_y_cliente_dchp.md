# Configuración del servidor y el cliente. Lista de concesiones.

## OBJETIVO: 

Tarea 3:

Muestra el fichero de configuración del servidor, la lista de concesiones, la modificación en la configuración que has hecho en el cliente para que tome la configuración de forma automática y muestra la salida del comando ` ip address`.


## Instalación del DCHP

* Instalamos el paquete para implantar el servicio de DCHP

```sh
root@servidor:/home/vagrant# apt-get install isc-dhcp-server
```

* Veremos que al instalarlo nos da una serie de errores:

Esto sucede porque aún no tenemos configurado el servidor DCHP.

```sh
● isc-dhcp-server.service - LSB: DHCP server
   Loaded: loaded (/etc/init.d/isc-dhcp-server; generated)
   Active: failed (Result: exit-code) since Mon 2020-10-26 13:20:03 GMT; 4ms ago
     Docs: man:systemd-sysv-generator(8)
  Process: 646 ExecStart=/etc/init.d/isc-dhcp-server start (code=exited, status=1/FAILURE)

Oct 26 13:20:01 servidor dhcpd[658]: bugs on either our web page at www.isc.org or in the README file
Oct 26 13:20:01 servidor dhcpd[658]: before submitting a bug.  These pages explain the proper
Oct 26 13:20:01 servidor dhcpd[658]: process and the information we find helpful for debugging.
Oct 26 13:20:01 servidor dhcpd[658]: 
Oct 26 13:20:01 servidor dhcpd[658]: exiting.
Oct 26 13:20:03 servidor isc-dhcp-server[646]: Starting ISC DHCPv4 server: dhcpdcheck syslog for diagnostics. ... failed!
Oct 26 13:20:03 servidor isc-dhcp-server[646]:  failed!
Oct 26 13:20:03 servidor systemd[1]: isc-dhcp-server.service: Control process exited, code=exited, status=1/FAILURE
Oct 26 13:20:03 servidor systemd[1]: isc-dhcp-server.service: Failed with result 'exit-code'.
Oct 26 13:20:03 servidor systemd[1]: Failed to start LSB: DHCP server.
Processing triggers for man-db (2.8.5-2) ...
Processing triggers for libc-bin (2.28-10) ...
Processing triggers for systemd (241-7~deb10u4) ...

```

* Primero vamos a editar el fichero **/etc/network/interfaces** que en principio tiene este aspecto:

<pre>nano /etc/network/interfaces</pre>

```sh

# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
allow-hotplug eth0
iface eth0 inet dhcp
#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
auto eth1
iface eth1 inet dhcp
    post-up ip route del default dev $IFACE || true
#VAGRANT-END

#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
auto eth2
iface eth2 inet static
      address 192.168.200.2
      netmask 255.255.255.0
#VAGRANT-END

```

* Vamos a editar la interfaz **eth2** que es la que vamos a utilizar para repartir direcciones IP.

```sh
#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
auto eth2
iface eth2 inet static
      address 192.168.200.2
      netmask 255.255.255.0
      gateway 192.168.200.1
      network 192.168.2.0
      broadcast 192.168.2.255
      dns-nameservers 8.8.8.8    
```

* Reiniciamos el servicio 

```sh
systemctl restart networking
```

* Ahora vamos a editar el fichero de configuracion isc-dhcp-server:

```sh
root@servidor:/home/vagrant# nano /etc/default/isc-dhcp-server 
```

* Deberemos de descomentar la siguiente linea y especificar la interfaz de red por la que vamos a servir las direcciones ip. En este caso es la 'eth2'. Guardamos y cerramos.

```sh
# On what interfaces should the DHCP server (dhcpd) serve DHCP requests?
#       Separate multiple interfaces with spaces, e.g. "eth0 eth1".

INTERFACESv4="eth2"

```

* Ahora debemos editar el fichero de configuracion del servicio DCHP **dhcpd.conf**.

```sh
root@servidor:/home/vagrant# nano /etc/dhcp/dhcpd.conf 

```
* Comentamos los ejemplos que nos ponen al principio, y descomentamos las líneas que nos van a
servir para nuestra configuración:

```sh
# A slightly different configuration for an internal subnet.
subnet 192.168.200.0 netmask 255.255.255.0 {
  range 192.168.200.50 192.168.200.70;
  option domain-name-servers 192.168.200.2;
  option domain-name "s01.local";
  option routers 192.168.200.1;
  option broadcast-address 192.168.200.255;
  default-lease-time 43200;
  max-lease-time 43200;
}

```

Explicación:

Usaremos el direccionamiento 192.168.200.0/24. En el rancho desde 192.1668.200.50 al 70. El dns lo tendremos configurado con la dirección ip de nuestro servidor con el nombre de "s01_local". Con la puerta de enlace del router de 192.168.200.1. El tiempo de concesión no será mayor a 12 horas. Pondremos 12 horas por defecto y de máximo.

* Guardamos y reiniciamos el servicio

```sh
root@servidor:/home/vagrant# /etc/init.d/isc-dhcp-server restart
[ ok ] Restarting isc-dhcp-server (via systemctl): isc-dhcp-server.service.
root@servidor:/home/vagrant# 

```
* Vemos el estado del servicio y comprobamos que está funcionando correctamente.

```sh
root@servidor:/home/vagrant# systemctl status isc-dhcp-server
● isc-dhcp-server.service - LSB: DHCP server
   Loaded: loaded (/etc/init.d/isc-dhcp-server; generated)
   Active: active (running) since Mon 2020-10-26 15:02:54 GMT; 51s ago
     Docs: man:systemd-sysv-generator(8)
  Process: 486 ExecStart=/etc/init.d/isc-dhcp-server start (code=exited, status=0/SUCCESS)
    Tasks: 1 (limit: 544)
   Memory: 5.1M
   CGroup: /system.slice/isc-dhcp-server.service
           └─498 /usr/sbin/dhcpd -4 -q -cf /etc/dhcp/dhcpd.conf eth2

Oct 26 15:02:52 servidor systemd[1]: Starting LSB: DHCP server...
Oct 26 15:02:52 servidor isc-dhcp-server[486]: Launching IPv4 server only.
Oct 26 15:02:52 servidor dhcpd[498]: Wrote 0 leases to leases file.
Oct 26 15:02:52 servidor dhcpd[498]: Server starting service.
Oct 26 15:02:54 servidor isc-dhcp-server[486]: Starting ISC DHCPv4 server: dhcpd.
Oct 26 15:02:54 servidor systemd[1]: Started LSB: DHCP server.
root@servidor:/home/vagrant# 

```

## Configurar cliente DHCP

* A continuación vamos a la máquina nodolan1 (nuestro cliente), y vamos a editar el fichero interfaces para que nuestra interfaz eth1 se conecte por dhcp a nuestro servidor y le sirva la nueva dirección. Guardamos el fichero y salimos.

```sh
# The contents below are automatically generated by Vagrant. Do not modify.
auto eth1
iface eth1 inet dchp  
#VAGRANT-END
```

* Reiniciamos el servicio o la máquina virtual.

**IMPORTANTE!!** Si en el fichero vagrantfile se ha configurado una dirección privada estática y la modificamos es posible que al reinciar nuestra máquina vagrant cree conflictos al modificar el fichero interfaces manualmente, para ello podemos elegir otro camino:

* Podemos eliminar la ip estática del cliente de esta forma: (necesitarás instalar el paquete *net-tools* aunque no es necesario ya que esto también se puede hacer con *ip a*).

```sh
apt-get install net-tools
```

```sh
root@nodolan1:/home/vagrant# ifdown eth1
```

```sh
root@nodolan1:/home/vagrant# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:8d:c0:4d brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic eth0
       valid_lft 86274sec preferred_lft 86274sec
    inet6 fe80::a00:27ff:fe8d:c04d/64 scope link 
       valid_lft forever preferred_lft forever
3: eth1: <BROADCAST,MULTICAST> mtu 1500 qdisc pfifo_fast state DOWN group default qlen 1000
    link/ether 08:00:27:72:06:97 brd ff:ff:ff:ff:ff:ff

```

* Ahora vamos a darle una dirección ip desde el servidor DCHP configurado previamente con el comando **dhclient**:

```sh
root@nodolan1:/home/vagrant# dhclient eth1

root@nodolan1:/home/vagrant# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:8d:c0:4d brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic eth0
       valid_lft 86259sec preferred_lft 86259sec
    inet6 fe80::a00:27ff:fe8d:c04d/64 scope link 
       valid_lft forever preferred_lft forever
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:72:06:97 brd ff:ff:ff:ff:ff:ff
    inet 192.168.200.51/24 brd 192.168.200.255 scope global dynamic eth1
       valid_lft 43198sec preferred_lft 43198sec
    inet6 fe80::a00:27ff:fe72:697/64 scope link 
       valid_lft forever preferred_lft forever
root@nodolan1:/home/vagrant# 

```
* Comprobamos que ha tomado la dirección ip adecuada **192.168.200.51**, en el rango de direcciones que habiamos indicado en el servidor.

